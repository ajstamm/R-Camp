
## We made it! But... {-}
<hr class="hr-lvl2">

It is not safe to land. Sounds like the Empire is checking all ships for permits. Darn.

There is some good news however. Our rebel comrades also sent along the coordinates of the Empires outposts. And they say that for a small ship like ours, it is technically possible to land undetected.  But we have to be able to put down right-dab in the middle of their 3 northern outposts?

> Are you up for a challenge data droid?

<br>

Either way, let's make a map and see what we're up against. Guess what the first step is? That's right. It is ime to add a new package. 



# <i class="fas fa-globe-africa"></i> Maps with `sf`
<hr>

### The `sf` package. {-}

![](../images/sf.gif){style="width: 21%; float: left; margin-right: 30px; margin-top: 8px; margin-bottom: 12px;"}


<br>

SF makes maps and spatial analysis in R feel like you're working with regular table data. It's full of spatial functions for calculating distances and areas, adding buffers around points, and all of your new dplyr toolbox functions will work as well. It's great. Let's get it!


<br>

<div style="clear: both;"></div>

<br>


### Install `sf` {-}

**Run:** 
```{r, eval=F}  
install.packages("sf")
```

<br>

```{r, eval=F, echo=F}
library(sf)
library(dplyr)

# Create coordinates
outposts <- tibble(ID = c("1NO","1NL","3NB"),
                   lat = c(36.6552, 36.583748, 36.5979), 
                   long = c(-118.8669, -118.8395, -118.92218))

outposts <- st_as_sf(outposts, coords = c("long", "lat"), crs = 4326)

outposts <- st_transform(outposts, 26915)


outposts$y_utm <- st_coordinates(outposts)[,2]
outposts$x_utm <- st_coordinates(outposts)[,1]

#outposts$crs <- "UTM Zone 15N; EPSG: 26915"

outposts <- select(outposts, ID, x_utm, y_utm, everything())

st_write(outposts, "../../../content/data/endor_outposts.shp")
```



## Read coordinates {-}
To read in coordinates stored in a spreadsheet or csv, we can read them the same with our usual friends read_csv and read_excel.

**Like this:**
```{r, eval=F} 
library(readr)

outposts <- read_csv("endor_outposts.csv")

# or
library(readxl)

outposts <- read_excel("endor_outposts.xlsx")
```


<br>

Unfortunately, Endor still uses ancient data systems and their spatial data is in a format once known as "shapefiles". But don't worry, we can do it all with `st_read()`. It's a real gem. 

**Give it a try:**
```{r, eval=T} 
library(sf)
library(dplyr)

outposts <- st_read("../../../content/data/endor_outposts.shp", quiet = T)
```



### Let's take a look {-}
```{r, eval=T} 
outposts

glimpse(outposts)

st_coordinates(outposts)
```


<br>

To make a quick map, use ggplot and add `geom_sf()`. 
```{r, eval=T, fig.width=8, fig.height=4} 
library(ggplot2)

ggplot(outposts) + geom_sf() 
```

<br>

## Where's the center? {-}

Do we need some trigonometry? Or can you use the functions we learned yesterday to calculate the center?

`Hint:` How do you find the center of 2 points?


<br>

Here's some code to get you started. 

*To calculate a single summary from all the data, we use `summarize()`.*

```{r, eval=F}
land_pad <- outposts %>%
            summarize(center_x = ___________,
                      center_y = ___________)
```




<details>
<summary class = "btn_code_green"> __Show code__ </summary>

<div style="margin-top: -12px;">
<p>
```{r, eval=T}
land_pad <- outposts %>%
            summarize(center_x = mean(x_utm),
                      center_y = mean(y_utm),
                      ID = "Land Here")
```
</p></div>
</details>


<br>


## The `st_centroid()` function {-}

```{r, eval=T}
land_pad <- outposts %>% 
            st_combine %>% 
            st_centroid()
```

<br>

### We found it! {-}

That's fantastic. But one more piece of bad news. Endor still uses an outdated coordinate system, and our ship will need coordinates in the WGS84 Lat/Lng format. They generally look like this `(45.6, -93.12)`. For more details see https://epsg.io/4326.

<br>

**SF** can help you with this too. Try using `st_transform()` and set the new CRS by adding the argument: `crs = 4326`. 


> `crs` = Coordinate reference system


```{r, eval=T}
# Transform outposts
outposts <- st_transform(outposts, crs = 4326)

# Transform landing pad
land_pad <- st_transform(land_pad, crs = 4326)
```


#### Wonderful!{-}

<br>

<div class="note">
<h3> Note </h3>

The CRS for the UTM coordinates zone 15N used for Minnesota is `26915`. See https://epsg.io/26915.

<br>
</div>


<br>

We're going to need to be pretty precise to land perfectly. To make our captain really happy, let's put this all in an interactive map. That way the pilot can zoom and move around. For interactive maps we use **leaflet**.


## Leaflet maps {-}
<hr class="hrlvl2">

### The `leaflet` package. {-}

![](../images/leaflet.png){style="width: 21%; float: left; margin-right: 30px; margin-top: 8px; margin-bottom: 12px;"}


<br>

Leaflet makes interactive maps easy and you build them up in layers similar to a ggplot.


<br>

<div style="clear: both;"></div>

<br>


### Install `leaflet` {-}

**Run:** 
```{r, eval=F}  
install.packages("leaflet")
```

<br>


## Maps that move {-}


### 1. Start with the outpost coordinates {-}
```{r, eval=T, fig.height=4, fig.width=9} 
library(leaflet)

leaflet(outposts) %>% 
  addCircles(radius = 250) %>%  
  addTiles()
```

<br>


### 2. Add the landing site {-}
```{r, eval=T, fig.height=4, fig.width=9}  
leaflet(outposts) %>% 
  addCircles(radius = 250) %>% 
  addTiles() %>%
  
  addMarkers(data  = land_pad)  #<<
```

<br>


### 3. Add labels {-}
```{r, eval=T, fig.height=4, fig.width=9} 
leaflet(outposts) %>% 
  addCircles(radius = 250,
             
             label = ~ID) %>%   #<<
  addTiles() %>%
  addMarkers(data  = land_pad,
             
             label = "Land HERE!",  #<<
             labelOptions = labelOptions(noHide = T))  #<<
```


<br>

**Wow.** I'm in awe of your work data droid. Let's just sit here a minute and soak it all in...  

Ok, let's get down on that planet before we're stuck up here with permanent space legs.

